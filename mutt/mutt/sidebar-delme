###########################
#                    BASICS
###########################

set mbox_type=maildir

# Putting this here asks for PW once only, not every folder switch
source "gpg2 -dq /home/username/.mutt/passwordfile.gpg |"

# This puts cursor just above signature in vim... the right place, but not common practice. Use [ to jump to top of message.
set editor='vim + -c "set textwidth=72" -c "set wrap" -c "set nocp" -c "?^$"'

# Split screen to view messages - can be slow with direct imap connection on larger mails
#set pager_index_lines=20

set sort='reverse-threads'
set sort_aux='last-date-received'
auto_view text/html
# This line gets rid of iso 8859 issues with attachments
set rfc2047_parameters

set sidebar_width=30
set sidebar_visible=yes
set sidebar_delim='|'
# Sorts folders in sidebar alphabetically
#set sidebar_sort=yes
set sidebar_shortpath = yes

color sidebar_new yellow default

bind index '[' sidebar-prev
bind index ']' sidebar-next
bind index '#' sidebar-open
bind pager '[' sidebar-prev
bind pager ']' sidebar-next
bind pager '#' sidebar-open

# Remap bounce-message function to “B” and toggle sb with b
bind index B bounce-message
macro index b '<enter-command>toggle sidebar_visible<enter><refresh>'
macro pager b '<enter-command>toggle sidebar_visible<enter><redraw-screen>'

# See all mail headers in editor, cache headers and bodies
set edit_headers=yes
set header_cache = "/home/username/.mutt/cache/headers"
set message_cachedir = "/home/username/.mutt/cache/bodies"

# Prettify
color hdrdefault white black  # headers white on black
color header brightgreen black ^From:  # sender's name in green
color quoted cyan black  # quoted text in blue
color signature red black   # signature in red

# Don't wait for sendmail to finish (this runs sendmail in the background)
#set sendmail_wait=-1

# A macro to store attachments in specific folder
macro attach , "<save-entry><bol>/home/username/emailattachments/<eol>" "Save to downloads folder"

#Alias file for addresses
set alias_file="/home/username/.mutt/.muttalias"
source /home/username/.mutt/.muttalias

#Use abook in addition to aliases - opting to not use it for now, as no autocomplete or BCC autofill
# Adding with shift-a was tempremental too
#set query_command= "abook --mutt-query '%s'"
#macro index,pager A "<pipe-message>abook --add-email-quiet<return>" "Add the sender address to abook"

###########################
#                       PGP
###########################

# Removed "--passphrase-fd 0" after "--output -" from a bunch of settings: decode, decrypt, sign, clearsign so as to use gpg-agent
#Also changed from pgpewrapng to /mutt/dir/pgpewrap to make it work for this setup

source /home/luxpir/.mutt/gpg.rc
set pgp_decode_command="gpg %?p? --no-verbose --batch --output - %f"
set pgp_verify_command="gpg --no-verbose --batch --output - --verify %s %f"
set pgp_decrypt_command="gpg --no-verbose --batch --output - %f"
set pgp_sign_command="gpg --no-verbose --batch --output - --armor --detach-sign --textmode %?a?-u %a? %f"
set pgp_clearsign_command="gpg --no-verbose --batch --output - --armor --textmode --clearsign %?a?-u %a? %f"
set pgp_encrypt_only_command="/home/username/mutt-1.5.24/pgpewrap gpg --batch --quiet --no-verbose --output - --encrypt --textmode --armor --always-trust --encrypt-to 0x085F086F -- -r %r -- %f"
set pgp_encrypt_sign_command="/home/username/mutt-1.5.24/pgpewrap gpg --batch --quiet --no-verbose --textmode --output - --encrypt --sign %?a?-u %a? --armor --always-trust --encrypt-to 0x085F086F -- -r %r -- %f"
set pgp_import_command="gpg --no-verbose --import -v %f"
set pgp_export_command="gpg --no-verbose --export --armor %r"
set pgp_verify_key_command="gpg --no-verbose --batch --fingerprint --check-sigs %r"
set pgp_list_pubring_command="gpg --no-verbose --batch --with-colons --list-keys %r"
set pgp_list_secring_command="gpg --no-verbose --batch --with-colons --list-secret-keys %r"
set pgp_sign_as=0x016G0FFF [replace this]
set crypt_replyencrypt=yes
set pgp_timeout=3600
set pgp_auto_decode=yes
set pgp_use_gpg_agent = yes

# set crypt_autosign=yes # not autosigning but nice option

###########################
#                  ACCOUNTS
###########################

## DEFAULT ACCOUNT
source "~/.mutt/default"

# Switch accounts with F keys
macro index <f2> '<sync-mailbox><refresh><enter-command>source ~/.mutt/default<enter><change-folder>!<enter>'
macro index <f3> '<sync-mailbox><refresh><enter-command>source ~/.mutt/second<enter><change-folder>!<enter>'
macro index <f4> '<sync-mailbox><refresh><enter-command>source ~/.mutt/third<enter><change-folder>!<enter>'
macro index <f5> '<sync-mailbox><refresh><enter-command>source ~/.mutt/fourth<enter><change-folder>!<enter>'

#Invoke notmuch, rebuild threads and tag emails as removed from Inbox?!
macro index <F8> \
     "<enter-command>unset wait_key<enter><shell-escape>notmuch-mutt --prompt search<enter><change-folder-readonly>`echo ${XDG_CACHE_HOME:-$HOME/.cache}/notmuch/mutt/results`<enter>" \
     "notmuch: search mail"
macro index <F9> \
     "<enter-command>unset wait_key<enter><pipe-message>notmuch-mutt thread<enter><change-folder-readonly>`echo ${XDG_CACHE_HOME:-$HOME/.cache}/notmuch/mutt/results`<enter><enter-command>set wait_key<enter>" \
     "notmuch: reconstruct thread"
macro index <F6> \
     "<enter-command>unset wait_key<enter><pipe-message>notmuch-mutt tag -Inbox<enter>" \
     "notmuch: remove message from inbox"
#Not sure what this F6 option is yet - still investigating

set certificate_file="~/.mutt/.mutt_known_hosts"
#Not massively secure, but works for my self-signed cert to avoid saving it repeatedly
set ssl_verify_host = no

###########################
#                CONNECTION
###########################

#Keeping below options from live imap connection settings in case they help with sending email via smtp
set ssl_starttls=yes
set ssl_force_tls=yes
unset imap_passive
set imap_check_subscribed
#set mail_check=60
set mail_check=20
# Above change for for isync, more frequent checks ftw
set timeout=10
set net_inc=5
set imap_keepalive = 300
